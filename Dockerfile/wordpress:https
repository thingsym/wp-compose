ARG WORDPRESS_IMAGE_TAG
ARG PHP_MEMORY_LIMIT
ARG PHP_UPLOAD_MAX_FILESIZE
ARG PHP_POST_MAX_SIZE
ARG PHP_MAX_EXECUTION_TIME

FROM wordpress:${WORDPRESS_IMAGE_TAG:-latest}

RUN echo "file_uploads = On\n" \
	"memory_limit        = ${PHP_MEMORY_LIMIT:-128M}\n" \
	"upload_max_filesize = ${PHP_UPLOAD_MAX_FILESIZE:-2M}\n" \
	"post_max_size       = ${PHP_POST_MAX_SIZE:-8M}\n" \
	"max_execution_time  = ${PHP_MAX_EXECUTION_TIME:-30}\n" \
	> /usr/local/etc/php/conf.d/uploads.ini \
	&& rm /usr/src/wordpress/wp-config-docker.php \
	&& cp /usr/src/wordpress/wp-config-sample.php /usr/src/wordpress/wp-config.php

RUN set -eux \
	&& a2enmod ssl \
	&& a2ensite default-ssl

RUN echo "[mail function]\n" \
	"sendmail_path = \"/usr/local/bin/mhsendmail --smtp-addr=mailhog:1025\"\n" \
	> /usr/local/etc/php/conf.d/mailhog.ini \
	&& /bin/bash -c 'set -ex && \
		ARCH=`uname -m` && \
		if [ "$ARCH" == "aarch64" ]; then \
				curl -sSL https://github.com/evertiro/mhsendmail/releases/download/v0.2.0-M1/mhsendmail_linux_arm64 -o mhsendmail; \
		else \
				curl -sSL https://github.com/mailhog/mhsendmail/releases/download/v0.2.0/mhsendmail_linux_amd64 -o mhsendmail; \
		fi' \
	&& chmod +x mhsendmail \
	&& mv mhsendmail /usr/local/bin/mhsendmail
